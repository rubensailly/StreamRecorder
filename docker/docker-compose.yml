version: "3.8"

services:
  recorder:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: yt-recorder:local
    container_name: yt-recorder
    working_dir: /app
    environment:
      - PYTHONUNBUFFERED=1
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - RECORDING_ROOT=/data/recordings
      - CHANNEL_IDS=@FRANCE24
      - POLL_INTERVAL_SEC=30
      - VIDEO_QUALITY=best
      - SEGMENT_TIME_SEC=300
      - METRICS_PORT=9100
      - API_PORT=8000
    env_file:
      - ../.env
    volumes:
      # Mount repo for live code; dependencies come from built image
      - ../:/app
      # Persist recordings and any runtime data
      - ../data:/data
    command: ["python3", "-m", "src.cli", "run"]
    ports:
      - "8000:8000"   # FastAPI API (if enabled)
      - "9100:9100"   # Prometheus metrics (if enabled)
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python3", "-c", "import socket; s=socket.socket(); s.connect(('127.0.0.1', 8000)); s.close()"]
      interval: 30s
      timeout: 5s
      retries: 3

  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: filebrowser
    volumes:
      # Mount recordings directory and a separate persistent database directory (directory, not file path)
      - ../data/recordings:/srv
      - ./filebrowser.db:/database
    environment:
      - FB_ADDRESS=0.0.0.0
      - FB_PORT=80
      - FB_ROOT=/srv
    ports:
      - "8080:80"
    restart: unless-stopped
